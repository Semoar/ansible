# Generated by ansible, DO NOT MODIFY DIRECTLY

# Basic settings
smtpd_banner = {{ mx_smtp_banner }}
biff = no
mail_name = {{ ansible_domain }}
myhostname = {{ ansible_fqdn }}
mydomain = {{ ansible_domain }}
mydestination = {{ ansible_fqdn }}, {{ ansible_domain }}, localhost.localdomain, localhost{% if mx_smtp_destination|length > 0 %}, {{ mx_smtp_destination|join(', ') }}{% endif %}

mynetworks = 127.0.0.0/8, [::1]/128{% if mx_smtp_network|length > 0 %}, {{ mx_smtp_network|join(', ') }}{% endif %}

recipient_delimiter = {{ mx_smtp_recipientdelimiter }}
luser_relay =

# Network config
inet_interfaces = {{ mx_smtp_inetinterfaces|join(', ') }}
inet_protocols = {{ mx_smtp_inetprotocols|join(', ') }}

# Queue settings
append_dot_mydomain = no
append_at_myorigin = yes
delay_warning_time = 4h
maximal_queue_lifetime = {{ mx_smtp_queuelifetime }}
message_size_limit = {{ mx_smtp_messagesizelimit }}
{% if 'secondarymx' in group_names %}

# Secondary MX
relayhost = {{ mx_smtp_relayto }}
relay_domains = {{ mx_smtp_relaydomains|join(', ') }}
relay_recipient_maps =
{% endif %}

# Aliases
alias_maps = hash:/etc/aliases, pcre:/etc/aliases-pcre
{% if mx_clamav_enabled or mx_spamassassin_enabled %}

# Content filtering
content_filter = scan:127.0.0.1:{{ mx_postfix_contentfilter }}
{% if mx_clamav_enabled %}
receive_override_options = no_address_mappings
{% endif %}
{% endif %}
{% if mx_dkim_enabled %}

# DKIM
milter_default_action = accept
milter_protocol = 6
{% if mx_clamav_enabled and mx_spamassassin_enabled %}
smtpd_milters = inet:127.0.0.1:{{ mx_postfix_contentfilter + 3 }}
non_smtpd_milters = inet:127.0.0.1:{{ mx_postfix_contentfilter + 3 }}
{% elif mx_clamav_enabled or mx_spamassassin_enabled %}
smtpd_milters = inet:127.0.0.1:{{ mx_postfix_contentfilter + 2 }}
non_smtpd_milters = inet:127.0.0.1:{{ mx_postfix_contentfilter + 2 }}
{% else %}
smtpd_milters = inet:127.0.0.1:{{ mx_postfix_contentfilter + 1 }}
non_smtpd_milters = inet:127.0.0.1:{{ mx_postfix_contentfilter + 1 }}
{% endif %}
{% endif %}
{% if mx_spf_enabled %}

# SPF
policyd-spf_time_limit = {{ mx_spf_timelimit }}
{% endif %}
{% if mx_sasl_enabled %}

# SASL
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = {{ ansible_domain }}
broken_sasl_auth_clients = yes
{% endif %}
{% if mx_tls_enabled %}

# TLS
smtp_use_tls = yes
smtpd_use_tls = yes
smtp_tls_note_starttls_offer = yes
smtpd_tls_key_file = /etc/ssl/private/dovecot.pem
smtpd_tls_cert_file = /etc/ssl/certs/dovecot.pem
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes
smtpd_tls_session_cache_timeout = 3600s
smtpd_tls_auth_only = yes
tls_random_source = dev:/dev/urandom
{% endif %}

# Basics Restrictions 
smtpd_delay_reject = yes
smtpd_helo_required = yes
strict_rfc821_envelopes = yes

# Requirements for the connecting server 
smtpd_client_restrictions =
    permit_mynetworks,
{% if mx_sasl_enabled %}
    permit_sasl_authenticated,
{% endif %}
{% if mx_rbl_enabled %}
{% for rbl in mx_rbl_servers %}
    reject_rbl_client {{ rbl }},
{% endfor %}
{% endif %}
    permit

# Requirements for the HELO statement 
smtpd_helo_restrictions =
    permit_mynetworks,
{% if mx_whitelist|length > 0 %}
    check_helo_access hash:/etc/postfix/whitelist,
{% endif %}
{% if mx_sasl_enabled %}
    permit_sasl_authenticated,
{% endif %}
    reject_non_fqdn_hostname,
    reject_invalid_hostname,
    permit

# Requirements for the sender address 
smtpd_sender_restrictions =
    permit_mynetworks,
{% if mx_whitelist|length > 0 %}
    check_sender_access hash:/etc/postfix/whitelist,
{% endif %}
{% if mx_sasl_enabled %}
    permit_sasl_authenticated,
{% endif %}
{% if mx_blacklist|length > 0 %}
    check_sender_access hash:/etc/postfix/blacklist,
{% endif %}
    reject_non_fqdn_sender,
    reject_unknown_sender_domain,
    permit

# Requirement for the recipient address 
smtpd_recipient_restrictions =
    permit_mynetworks,
{% if mx_whitelist|length > 0 %}
    check_recipient_access hash:/etc/postfix/whitelist,
{% endif %}
{% if mx_sasl_enabled %}
    permit_sasl_authenticated,
{% endif %}
    reject_non_fqdn_recipient,
    reject_unknown_recipient_domain,
    reject_unauth_destination,
{% if mx_postgrey_enabled %}
    check_policy_service inet:127.0.0.1:{{ mx_postgrey_port }},
{% endif %}
{% if mx_spf_enabled %}
    check_policy_service unix:private/policyd-spf,
{% endif %}
    permit
{% if mx_dovecot_enabled %}

# Delivering
mailbox_command = /usr/lib/dovecot/dovecot-lda -f "$SENDER" -a "$RECIPIENT"
{% endif %}
